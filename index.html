<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width" />
        <title>Matrix Board Test</title>
        <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font: 16px sans-serif;
            color: #CCC;
        }
        canvas {
            background-color: #EEE;
            width: 100%;
            height: 100%;
            background-color: #456990;
        }
        </style>
    </head>
    <body>
        <canvas></canvas>
        <script>
"use strict";

var Cell = function(row, col, type, primarySelection, secondarySelection) {
    this.row = row;
    this.col = col;
    this.type = type;
    this.primarySelection = primarySelection;
    this.secondarySelection = secondarySelection;
}

var Matrix = function(width, height, canvas, autoResize) {
    this.board = [];
    this.width = width;
    this.height = height;
    for (var row = 0; row < this.height; row++) {
        var line = [];
        this.board.push(line);
        for (var col = 0; col < this.width; col++) {
            line.push(new Cell(row, col, 1));
        }
    }

    this.canvas = canvas || document.getElementsByTagName('canvas')[0];
    this.context = this.canvas.getContext('2d');

    this.fillStyles = {0: 'none', 1: '#459990', 2: '#CC3333', 3: '#33DD33'};
    this.selectionStyle = {1: 'rgba(220, 220, 220)', 2: 'rgb(220, 220, 220, 0.2)'};

    if (autoResize === undefined || autoResize) {
        this.resize();
        var self = this;
        window.onresize = function() {
            self.resize();
            self.updateDimensions();
            self.render(self.board);
        };
    }

    this.updateDimensions();
}

Matrix.prototype.resize = function() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
}

Matrix.prototype.updateDimensions = function() {
    this.width = this.board[0].length;
    this.height = this.board.length;

    this.canvasPadding = this.canvas.height / 20;
    this.cellSpace = Math.min((this.canvas.width - 2*this.canvasPadding) / this.width, (this.canvas.height - 2*this.canvasPadding) / this.height);
    if (this.cellSpace > 10) {
        this.cellPadding = Math.max(1, this.cellSpace / 20);
    } else {
        this.cellPadding = 0;
    }
    this.cellBorder = this.cellSpace / 5;
    this.cellSize = this.cellSpace - this.cellPadding * 2;
}

Matrix.prototype.render = function () {
    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);

    for (var col = 0; col < this.width; col++) {
        var x = this.canvas.width/2 + (col-this.width/2)*this.cellSpace;

        for (var row = 0; row < this.height; row++) {
            var y = this.canvasPadding + row * this.cellSpace;

            var cell = this.board[row][col];
            if (cell.type === 0) {
                continue;
            }

            var fillStyle = this.fillStyles[cell.type];
            var borderStyle = '#CCC';
            var primarySelectionStyle = this.selectionStyle[cell.primarySelection];
            var secondarySelectionStyle = this.selectionStyle[cell.secondarySelection];

            this.context.fillStyle = fillStyle;
            this.context.fillRect(x + this.cellPadding, y,
                             this.cellSize, this.cellSize);
            if (this.cellSpace > 10) {
                this.context.strokeStyle = borderStyle;
                this.context.strokeRect(x + this.cellPadding, y,
                                   this.cellSize, this.cellSize);
            }

            if (cell.primarySelection) {
                this.context.fillStyle = primarySelectionStyle;
                this.context.beginPath();
                this.context.moveTo(x+this.cellBorder+this.cellPadding, y+this.cellBorder);
                this.context.lineTo(x+this.cellSize-this.cellBorder+this.cellPadding, y+this.cellBorder);
                this.context.lineTo(x+this.cellBorder+this.cellPadding, y+this.cellSize-this.cellBorder);
                this.context.fill();
            }
            if (cell.secondarySelection) {
                this.context.fillStyle = secondarySelectionStyle;
                this.context.beginPath();
                this.context.moveTo(x+this.cellPadding+this.cellSize-this.cellBorder, y+this.cellSize-this.cellBorder);
                this.context.lineTo(x+this.cellPadding+this.cellSize-this.cellBorder, y+this.cellBorder);
                this.context.lineTo(x+this.cellPadding+this.cellBorder, y+this.cellSize-this.cellBorder);
                this.context.fill();
            }
        }
    }
}

Matrix.prototype.forEach = function(fn) {
    for (var row = 0; row < this.height; row++) {
        for (var col = 0; col < this.width; col++) {
            fn(this.board[row][col]);
        }
    }
}

var m = new Matrix(5, 5);

setInterval(function() {
    m.forEach(function(cell) {
        cell.type = (Math.random()*4)|0;
    });
    m.render();    
}, 500);

        </script>
    </body>
</html>
